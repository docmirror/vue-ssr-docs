<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Caching | Vue SSR 指南</title>
    <meta name="description" content="Vue.js 服务端渲染指南">
    
    
    <link rel="preload" href="/assets/css/0.styles.6216b4ed.css" as="style"><link rel="preload" href="/assets/js/app.857f8442.js" as="script"><link rel="preload" href="/assets/js/55.b28f8acf.js" as="script"><link rel="prefetch" href="/assets/js/31.e70f56c9.js"><link rel="prefetch" href="/assets/js/1.4ba6ebae.js"><link rel="prefetch" href="/assets/js/2.535f3c53.js"><link rel="prefetch" href="/assets/js/3.e5730be8.js"><link rel="prefetch" href="/assets/js/4.0d83e6d4.js"><link rel="prefetch" href="/assets/js/5.9206f5fa.js"><link rel="prefetch" href="/assets/js/6.01fc6541.js"><link rel="prefetch" href="/assets/js/7.044d3af9.js"><link rel="prefetch" href="/assets/js/8.6a2b3380.js"><link rel="prefetch" href="/assets/js/9.63f778c7.js"><link rel="prefetch" href="/assets/js/10.f7960911.js"><link rel="prefetch" href="/assets/js/11.a592910a.js"><link rel="prefetch" href="/assets/js/12.6717a33d.js"><link rel="prefetch" href="/assets/js/13.682a40a0.js"><link rel="prefetch" href="/assets/js/14.98252396.js"><link rel="prefetch" href="/assets/js/15.fcc3f916.js"><link rel="prefetch" href="/assets/js/16.18e3e209.js"><link rel="prefetch" href="/assets/js/17.d5012f0a.js"><link rel="prefetch" href="/assets/js/18.3facfce8.js"><link rel="prefetch" href="/assets/js/19.6bced45f.js"><link rel="prefetch" href="/assets/js/20.f31829e2.js"><link rel="prefetch" href="/assets/js/21.9f5a2bb3.js"><link rel="prefetch" href="/assets/js/22.67a7b679.js"><link rel="prefetch" href="/assets/js/23.86b71d0a.js"><link rel="prefetch" href="/assets/js/24.9a66fd58.js"><link rel="prefetch" href="/assets/js/25.f9522ed8.js"><link rel="prefetch" href="/assets/js/26.6e7f9c0d.js"><link rel="prefetch" href="/assets/js/27.e9d08b47.js"><link rel="prefetch" href="/assets/js/28.76611bff.js"><link rel="prefetch" href="/assets/js/29.ea593b17.js"><link rel="prefetch" href="/assets/js/30.c5eb0f84.js"><link rel="prefetch" href="/assets/js/32.5f5dd21a.js"><link rel="prefetch" href="/assets/js/33.0a625a25.js"><link rel="prefetch" href="/assets/js/34.d2733537.js"><link rel="prefetch" href="/assets/js/35.ddc557a5.js"><link rel="prefetch" href="/assets/js/36.a489edf1.js"><link rel="prefetch" href="/assets/js/37.136d8c88.js"><link rel="prefetch" href="/assets/js/38.cf5a3a6d.js"><link rel="prefetch" href="/assets/js/39.e9646dd4.js"><link rel="prefetch" href="/assets/js/40.4ce1a813.js"><link rel="prefetch" href="/assets/js/41.da8c6de2.js"><link rel="prefetch" href="/assets/js/42.c04c89ae.js"><link rel="prefetch" href="/assets/js/43.150fa123.js"><link rel="prefetch" href="/assets/js/44.fe85991f.js"><link rel="prefetch" href="/assets/js/45.a7ccbd7a.js"><link rel="prefetch" href="/assets/js/46.80bff42e.js"><link rel="prefetch" href="/assets/js/47.3938d7f5.js"><link rel="prefetch" href="/assets/js/48.bc91a1ba.js"><link rel="prefetch" href="/assets/js/49.311640c6.js"><link rel="prefetch" href="/assets/js/50.d3346077.js"><link rel="prefetch" href="/assets/js/51.e7924f3c.js"><link rel="prefetch" href="/assets/js/52.41301aea.js"><link rel="prefetch" href="/assets/js/53.ef26fe4d.js"><link rel="prefetch" href="/assets/js/54.5f99a77e.js"><link rel="prefetch" href="/assets/js/56.c1e1643d.js"><link rel="prefetch" href="/assets/js/57.bfaa829e.js"><link rel="prefetch" href="/assets/js/58.97c40fd9.js"><link rel="prefetch" href="/assets/js/59.96f5b32e.js"><link rel="prefetch" href="/assets/js/60.5605712f.js"><link rel="prefetch" href="/assets/js/61.5678ceef.js"><link rel="prefetch" href="/assets/js/62.6717708a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6216b4ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vue SSR 指南</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/caching.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/guide/caching.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/ru/guide/caching.html" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/caching.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/guide/caching.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/ru/guide/caching.html" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div style="padding:20px 30px  0px 30px;"><a target="_blank" href="https://www.aliyun.com/minisite/goods?userCode=qya11txb" style="width:100%"><img src="https://img.alicdn.com/tfs/TB1qnR3R1L2gK0jSZFmXXc7iXXa-440-240.jpg" style="width:100%"></a></div> <ul class="sidebar-links"><li><a href="/zh/" class="sidebar-link">介绍</a></li><li><a href="/zh/guide/" class="sidebar-link">基本用法</a></li><li><a href="/zh/guide/universal.html" class="sidebar-link">编写通用代码</a></li><li><a href="/zh/guide/structure.html" class="sidebar-link">源码结构</a></li><li><a href="/zh/guide/routing.html" class="sidebar-link">路由和代码分割</a></li><li><a href="/zh/guide/data.html" class="sidebar-link">数据预取和状态</a></li><li><a href="/zh/guide/hydration.html" class="sidebar-link">客户端激活 (client-side hydration)</a></li><li><a href="/zh/guide/bundle-renderer.html" class="sidebar-link">Bundle Renderer 指引</a></li><li><a href="/zh/guide/build-config.html" class="sidebar-link">构建配置</a></li><li><a href="/zh/guide/css.html" class="sidebar-link">CSS 管理</a></li><li><a href="/zh/guide/head.html" class="sidebar-link">Head 管理</a></li><li><a href="/zh/guide/caching.html" class="sidebar-link">缓存</a></li><li><a href="/zh/guide/streaming.html" class="sidebar-link">流式渲染 (Streaming)</a></li><li><a href="/zh/guide/non-node.html" class="sidebar-link">在非 Node.js 环境中使用</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="caching"><a href="#caching" aria-hidden="true" class="header-anchor">#</a> Caching</h1> <p>Although Vue's SSR is quite fast, it can't match the performance of pure string-based templating due to the cost of creating component instances and Virtual DOM nodes. In cases where SSR performance is critical, wisely leveraging caching strategies can greatly improve response time and reduce server load.</p> <h2 id="page-level-caching"><a href="#page-level-caching" aria-hidden="true" class="header-anchor">#</a> Page-level Caching</h2> <p>A server-rendered app in most cases relies on external data, so the content is dynamic by nature and cannot be cached for extended periods. However, if the content is not user-specific (i.e. for the same URL it always renders the same content for all users), we can leverage a strategy called <a href="https://www.nginx.com/blog/benefits-of-microcaching-nginx/" target="_blank" rel="noopener noreferrer">micro-caching<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to drastically improve our app's capability of handling high traffic.</p> <p>This is usually done at the Nginx layer, but we can also implement it in Node.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> microCache <span class="token operator">=</span> <span class="token constant">LRU</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  max<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  maxAge<span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token comment">// Important: entries expires after 1 second.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">isCacheable</span> <span class="token operator">=</span> req <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// implement logic to check if the request is user-specific.</span>
  <span class="token comment">// only non-user-specific pages are cache-able</span>
<span class="token punctuation">}</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cacheable <span class="token operator">=</span> <span class="token function">isCacheable</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hit <span class="token operator">=</span> microCache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>hit<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      microCache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> html<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Since the content is cached for only one second, users will not see outdated content. However, this means the server only has to perform at most one full render per second for each cached page.</p> <h2 id="component-level-caching"><a href="#component-level-caching" aria-hidden="true" class="header-anchor">#</a> Component-level Caching</h2> <p><code>vue-server-renderer</code> has built-in support for component-level caching. To enable it you need to provide a <a href="/api/#cache">cache implementation</a> when creating the renderer. Typical usage is passing in an <a href="https://github.com/isaacs/node-lru-cache" target="_blank" rel="noopener noreferrer">lru-cache<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">LRU</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lru-cache'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cache<span class="token punctuation">:</span> <span class="token constant">LRU</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    max<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    maxAge<span class="token punctuation">:</span> <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>You can then cache a component by implementing a <code>serverCacheKey</code> function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'item'</span><span class="token punctuation">,</span> <span class="token comment">// required</span>
  props<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'item'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  serverCacheKey<span class="token punctuation">:</span> props <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span>item<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  <span class="token function">render</span> <span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>item<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note that cache-able component <strong>must also define a unique <code>name</code> option</strong>. With a unique name, the cache key is thus per-component: you don't need to worry about two components returning the same key.</p> <p>The key returned from <code>serverCacheKey</code> should contain sufficient information to represent the shape of the render result. The above is a good implementation if the render result is solely determined by <code>props.item.id</code>. However, if the item with the same id may change over time, or if render result also relies on another prop, then you need to modify your <code>serverCacheKey</code> implementation to take those other variables into account.</p> <p>Returning a constant will cause the component to always be cached, which is good for purely static components.</p> <div class="tip custom-block"><p class="custom-block-title">Bailing out from Caching</p> <p>Since 2.6.0, explicitly returning <code>false</code> in <code>serverCacheKey</code> will cause the component to bail out of caching and be rendered afresh.</p></div> <h3 id="when-to-use-component-caching"><a href="#when-to-use-component-caching" aria-hidden="true" class="header-anchor">#</a> When to use component caching</h3> <p>If the renderer hits a cache for a component during render, it will directly reuse the cached result for the entire sub tree. This means you should <strong>NOT</strong> cache a component when:</p> <ul><li>It has child components that may rely on global state.</li> <li>It has child components that produces side effects on the render <code>context</code>.</li></ul> <p>Component caching should therefore be applied carefully to address performance bottlenecks. In most cases, you shouldn't and don't need to cache single-instance components. The most common type of components that are suitable for caching are ones repeated in big <code>v-for</code> lists. Since these components are usually driven by objects in database collections, they can make use of a simple caching strategy: generate their cache keys using their unique id plus the last updated timestamp:</p> <div class="language-js extra-class"><pre class="language-js"><code>serverCacheKey<span class="token punctuation">:</span> props <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span>item<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'::'</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>item<span class="token punctuation">.</span>last_updated
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/55.b28f8acf.js" defer></script><script src="/assets/js/app.857f8442.js" defer></script>
  </body>
</html>
