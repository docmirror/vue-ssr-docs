<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Структура исходного кода | Руководство Vue SSR</title>
    <meta name="description" content="Руководство по серверному рендерингу Vue.js">
    
    
    <link rel="preload" href="/assets/css/0.styles.6216b4ed.css" as="style"><link rel="preload" href="/assets/js/app.857f8442.js" as="script"><link rel="preload" href="/assets/js/17.d5012f0a.js" as="script"><link rel="prefetch" href="/assets/js/31.e70f56c9.js"><link rel="prefetch" href="/assets/js/1.4ba6ebae.js"><link rel="prefetch" href="/assets/js/2.535f3c53.js"><link rel="prefetch" href="/assets/js/3.e5730be8.js"><link rel="prefetch" href="/assets/js/4.0d83e6d4.js"><link rel="prefetch" href="/assets/js/5.9206f5fa.js"><link rel="prefetch" href="/assets/js/6.01fc6541.js"><link rel="prefetch" href="/assets/js/7.044d3af9.js"><link rel="prefetch" href="/assets/js/8.6a2b3380.js"><link rel="prefetch" href="/assets/js/9.63f778c7.js"><link rel="prefetch" href="/assets/js/10.f7960911.js"><link rel="prefetch" href="/assets/js/11.a592910a.js"><link rel="prefetch" href="/assets/js/12.6717a33d.js"><link rel="prefetch" href="/assets/js/13.682a40a0.js"><link rel="prefetch" href="/assets/js/14.98252396.js"><link rel="prefetch" href="/assets/js/15.fcc3f916.js"><link rel="prefetch" href="/assets/js/16.18e3e209.js"><link rel="prefetch" href="/assets/js/18.3facfce8.js"><link rel="prefetch" href="/assets/js/19.6bced45f.js"><link rel="prefetch" href="/assets/js/20.f31829e2.js"><link rel="prefetch" href="/assets/js/21.9f5a2bb3.js"><link rel="prefetch" href="/assets/js/22.67a7b679.js"><link rel="prefetch" href="/assets/js/23.86b71d0a.js"><link rel="prefetch" href="/assets/js/24.9a66fd58.js"><link rel="prefetch" href="/assets/js/25.f9522ed8.js"><link rel="prefetch" href="/assets/js/26.6e7f9c0d.js"><link rel="prefetch" href="/assets/js/27.e9d08b47.js"><link rel="prefetch" href="/assets/js/28.76611bff.js"><link rel="prefetch" href="/assets/js/29.ea593b17.js"><link rel="prefetch" href="/assets/js/30.c5eb0f84.js"><link rel="prefetch" href="/assets/js/32.5f5dd21a.js"><link rel="prefetch" href="/assets/js/33.0a625a25.js"><link rel="prefetch" href="/assets/js/34.d2733537.js"><link rel="prefetch" href="/assets/js/35.ddc557a5.js"><link rel="prefetch" href="/assets/js/36.a489edf1.js"><link rel="prefetch" href="/assets/js/37.136d8c88.js"><link rel="prefetch" href="/assets/js/38.cf5a3a6d.js"><link rel="prefetch" href="/assets/js/39.e9646dd4.js"><link rel="prefetch" href="/assets/js/40.4ce1a813.js"><link rel="prefetch" href="/assets/js/41.da8c6de2.js"><link rel="prefetch" href="/assets/js/42.c04c89ae.js"><link rel="prefetch" href="/assets/js/43.150fa123.js"><link rel="prefetch" href="/assets/js/44.fe85991f.js"><link rel="prefetch" href="/assets/js/45.a7ccbd7a.js"><link rel="prefetch" href="/assets/js/46.80bff42e.js"><link rel="prefetch" href="/assets/js/47.3938d7f5.js"><link rel="prefetch" href="/assets/js/48.bc91a1ba.js"><link rel="prefetch" href="/assets/js/49.311640c6.js"><link rel="prefetch" href="/assets/js/50.d3346077.js"><link rel="prefetch" href="/assets/js/51.e7924f3c.js"><link rel="prefetch" href="/assets/js/52.41301aea.js"><link rel="prefetch" href="/assets/js/53.ef26fe4d.js"><link rel="prefetch" href="/assets/js/54.5f99a77e.js"><link rel="prefetch" href="/assets/js/55.b28f8acf.js"><link rel="prefetch" href="/assets/js/56.c1e1643d.js"><link rel="prefetch" href="/assets/js/57.bfaa829e.js"><link rel="prefetch" href="/assets/js/58.97c40fd9.js"><link rel="prefetch" href="/assets/js/59.96f5b32e.js"><link rel="prefetch" href="/assets/js/60.5605712f.js"><link rel="prefetch" href="/assets/js/61.5678ceef.js"><link rel="prefetch" href="/assets/js/62.6717708a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6216b4ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ru/" class="home-link router-link-active"><!----> <span class="site-name">Руководство Vue SSR</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ru/guide/" class="nav-link router-link-active">Руководство</a></div><div class="nav-item"><a href="/ru/api/" class="nav-link">Справочник API</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Переводы</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/structure.html" class="nav-link">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/guide/structure.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/ru/guide/structure.html" class="nav-link router-link-exact-active router-link-active">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ru/guide/" class="nav-link router-link-active">Руководство</a></div><div class="nav-item"><a href="/ru/api/" class="nav-link">Справочник API</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Переводы</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/structure.html" class="nav-link">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/guide/structure.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/ru/guide/structure.html" class="nav-link router-link-exact-active router-link-active">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div style="padding:20px 30px  0px 30px;"><a target="_blank" href="https://www.aliyun.com/minisite/goods?userCode=qya11txb" style="width:100%"><img src="https://img.alicdn.com/tfs/TB1qnR3R1L2gK0jSZFmXXc7iXXa-440-240.jpg" style="width:100%"></a></div> <ul class="sidebar-links"><li><a href="/ru/" class="sidebar-link">Введение</a></li><li><a href="/ru/guide/" class="sidebar-link">Начало работы</a></li><li><a href="/ru/guide/universal.html" class="sidebar-link">Написание универсального кода</a></li><li><a href="/ru/guide/structure.html" class="active sidebar-link">Структура исходного кода</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ru/guide/structure.html#избегайте-сингnтонов-с-состоянием" class="sidebar-link">Избегайте синглтонов с состоянием</a></li><li class="sidebar-sub-header"><a href="/ru/guide/structure.html#представnяем-шаг-сборки" class="sidebar-link">Представляем шаг сборки</a></li><li class="sidebar-sub-header"><a href="/ru/guide/structure.html#структура-кода-с-webpack" class="sidebar-link">Структура кода с Webpack</a></li></ul></li><li><a href="/ru/guide/routing.html" class="sidebar-link">Маршрутизация и разделение кода</a></li><li><a href="/ru/guide/data.html" class="sidebar-link">Предзагрузка данных и состояния</a></li><li><a href="/ru/guide/hydration.html" class="sidebar-link">Гидратация клиентской части</a></li><li><a href="/ru/guide/bundle-renderer.html" class="sidebar-link">Представляем Bundle Renderer</a></li><li><a href="/ru/guide/build-config.html" class="sidebar-link">Конфигурация сборки</a></li><li><a href="/ru/guide/css.html" class="sidebar-link">Управление CSS</a></li><li><a href="/ru/guide/head.html" class="sidebar-link">Управление head-тегами</a></li><li><a href="/ru/guide/caching.html" class="sidebar-link">Кэширование</a></li><li><a href="/ru/guide/streaming.html" class="sidebar-link">Стриминг</a></li><li><a href="/ru/guide/non-node.html" class="sidebar-link">Использование в не-Node.js окружениях</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="структура-исходного-кода"><a href="#структура-исходного-кода" aria-hidden="true" class="header-anchor">#</a> Структура исходного кода</h1> <h2 id="избегайте-сингnтонов-с-состоянием"><a href="#избегайте-сингnтонов-с-состоянием" aria-hidden="true" class="header-anchor">#</a> Избегайте синглтонов с состоянием</h2> <p>При написании кода для клиентской стороны мы привыкли к тому, что наш код каждый раз будет выполняться в новом контексте. Однако сервер Node.js является длительным процессом (long-running process). Поэтому когда наш код потребуется, он будет выполнен один раз и останется в памяти. Это означает, что если вы создаёте объект синглтон, он будет использоваться для всех входящих запросов.</p> <p>Как видно из простого примера, мы <strong>создаём новый корневой экземпляр Vue для каждого запроса</strong>. Это схоже с тем, когда каждый пользователь будет использовать свежий экземпляр приложения в своём браузере. Если мы будем использовать общий экземпляр для нескольких запросов, то это быстро приведёт к загрязнению состояния.</p> <p>Поэтому, вместо непосредственного создания экземпляра приложения, мы должны предоставить функцию-фабрику, которую можно повторно вызывать для создания свежих экземпляров приложения на каждый запрос:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> context<span class="token punctuation">.</span>url
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`&lt;div&gt;Вы открыли URL: {{ url }}&lt;/div&gt;`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Код нашего сервера станет таким:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> createApp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> req<span class="token punctuation">.</span>url <span class="token punctuation">}</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

  renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// обработка ошибок...</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Это правило также применимо и к экземплярам маршрутизатора (router), хранилища (store) и шины событий (event bus). Вместо того, чтобы непосредственно экспортировать из модуля и импортировать везде в приложении, вам нужно создавать новый экземпляр в <code>createApp</code> и внедрять его из корневого экземпляра Vue.</p> <blockquote><p>Это ограничение можно обойти при использовании рендерера сборки с опцией <code>{ runInNewContext: true }</code>, однако это сопряжено с некоторыми существенными затратами производительности, поскольку для каждого запроса потребуется создание нового контекста vm.</p></blockquote> <h2 id="представnяем-шаг-сборки"><a href="#представnяем-шаг-сборки" aria-hidden="true" class="header-anchor">#</a> Представляем шаг сборки</h2> <p>До сих пор мы не обсуждали каким образом доставлять клиенту такое приложение Vue. Чтобы сделать это, мы должны использовать Webpack для сборки нашего приложения Vue. На самом деле, мы вероятно захотим использовать Webpack для сборки приложения Vue также и на сервере, потому что:</p> <ul><li><p>Типичные приложения Vue собраны с помощью Webpack и <code>vue-loader</code>, и многие Webpack-специфичные вещи, такие как импорт файлов через <code>file-loader</code>, импорт CSS через <code>css-loader</code> не будут работать напрямую в Node.js.</p></li> <li><p>Несмотря на то, что последняя версия Node.js полностью поддерживает ES2015, нам всё же необходимо транспилировать код для клиентской части для совместимости со старыми браузерами. Это снова предполагает шаг сборки.</p></li></ul> <p>Поэтому основная идея заключается в том, что мы будем использовать Webpack для сборки нашего приложения как для клиента, так и для сервера — сборка для сервера будет необходима серверу и использоваться для серверного рендеринга, в то время как сборка для клиента будет отправляться в браузер для гидратации статической разметки.</p> <p><img src="https://cloud.githubusercontent.com/assets/499550/17607895/786a415a-5fee-11e6-9c11-45a2cfdf085c.png" alt="architecture"></p> <p>Мы обсудим подробности настройки в следующих разделах — а сейчас, давайте представим что у нас реализован шаг сборки и мы можем писать код нашего приложения Vue с использованием Webpack.</p> <h2 id="структура-кода-с-webpack"><a href="#структура-кода-с-webpack" aria-hidden="true" class="header-anchor">#</a> Структура кода с Webpack</h2> <p>Теперь, когда мы используем Webpack для обработки приложения как для сервера, так и для клиента, большая часть нашего исходного кода может быть написана в универсальном «стиле», с доступом ко всем функциям на основе Webpack. В тоже время, есть <a href="/ru/guide/universal.html">ряд вещей</a>, которые вы должны иметь ввиду при написании универсального кода.</p> <p>Простой проект может выглядеть подобным образом:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>src
├── components
│   ├── Foo.vue
│   ├── Bar.vue
│   └── Baz.vue
├── App.vue
├── app.js <span class="token comment"># универсальная точка входа</span>
├── entry-client.js <span class="token comment"># запускается только в браузере</span>
└── entry-server.js <span class="token comment"># запускается только на сервере</span>
</code></pre></div><h3 id="app-js"><a href="#app-js" aria-hidden="true" class="header-anchor">#</a> <code>app.js</code></h3> <p><code>app.js</code> — универсальная точка входа в наше приложение. В только клиентском приложении, мы бы создавали корневой экземпляр Vue прямо в этом файле и монтировали непосредственно в DOM. Однако при использовании серверного рендеринга эта ответственность переносится в файл клиентской точки входа (<code>entry-client.js</code>). <code>app.js</code> просто экспортирует функцию <code>createApp</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token comment">// экспортируем функцию фабрику для создания экземпляров</span>
<span class="token comment">// нового приложения, маршрутизатора и хранилища</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// корневой экземпляр просто рендерит компонент App</span>
    render<span class="token punctuation">:</span> h <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="entry-client-js"><a href="#entry-client-js" aria-hidden="true" class="header-anchor">#</a> <code>entry-client.js</code>:</h3> <p>Клиентская точка входа — просто создаёт приложение и монтирует его в DOM:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment">// Специфичная для клиента логика загрузки...</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// предполагается, что у корневого элемента в шаблоне App.vue есть элемент с `id=&quot;app&quot;`</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="entry-server-js"><a href="#entry-server-js" aria-hidden="true" class="header-anchor">#</a> <code>entry-server.js</code>:</h3> <p>Серверная точка входа — экспортирует по умолчанию функцию, которая будет вызываться повторно для каждого рендеринга. На данный момент не делаем ничего, кроме создания и возврата экземпляра приложения, но, позднее, мы будем выполнять здесь логику сопоставления маршрутов и предзагрузки данных.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> context <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/ru/guide/universal.html" class="prev">
          Написание универсального кода
        </a></span> <span class="next"><a href="/ru/guide/routing.html">
          Маршрутизация и разделение кода
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/17.d5012f0a.js" defer></script><script src="/assets/js/app.857f8442.js" defer></script>
  </body>
</html>
