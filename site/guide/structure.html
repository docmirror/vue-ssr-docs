<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Source Code Structure | Vue SSR 指南</title>
    <meta name="description" content="Vue.js 服务端渲染指南">
    
    
    <link rel="preload" href="/site/assets/css/0.styles.1ec459c2.css" as="style"><link rel="preload" href="/site/assets/js/app.5a972c74.js" as="script"><link rel="preload" href="/site/assets/js/47.3938d7f5.js" as="script"><link rel="prefetch" href="/site/assets/js/31.e70f56c9.js"><link rel="prefetch" href="/site/assets/js/1.4ba6ebae.js"><link rel="prefetch" href="/site/assets/js/2.535f3c53.js"><link rel="prefetch" href="/site/assets/js/3.e5730be8.js"><link rel="prefetch" href="/site/assets/js/4.0d83e6d4.js"><link rel="prefetch" href="/site/assets/js/5.9206f5fa.js"><link rel="prefetch" href="/site/assets/js/6.01fc6541.js"><link rel="prefetch" href="/site/assets/js/7.044d3af9.js"><link rel="prefetch" href="/site/assets/js/8.6a2b3380.js"><link rel="prefetch" href="/site/assets/js/9.63f778c7.js"><link rel="prefetch" href="/site/assets/js/10.f7960911.js"><link rel="prefetch" href="/site/assets/js/11.a592910a.js"><link rel="prefetch" href="/site/assets/js/12.6717a33d.js"><link rel="prefetch" href="/site/assets/js/13.682a40a0.js"><link rel="prefetch" href="/site/assets/js/14.98252396.js"><link rel="prefetch" href="/site/assets/js/15.fcc3f916.js"><link rel="prefetch" href="/site/assets/js/16.18e3e209.js"><link rel="prefetch" href="/site/assets/js/17.d5012f0a.js"><link rel="prefetch" href="/site/assets/js/18.3facfce8.js"><link rel="prefetch" href="/site/assets/js/19.6bced45f.js"><link rel="prefetch" href="/site/assets/js/20.f31829e2.js"><link rel="prefetch" href="/site/assets/js/21.9f5a2bb3.js"><link rel="prefetch" href="/site/assets/js/22.67a7b679.js"><link rel="prefetch" href="/site/assets/js/23.86b71d0a.js"><link rel="prefetch" href="/site/assets/js/24.9a66fd58.js"><link rel="prefetch" href="/site/assets/js/25.f9522ed8.js"><link rel="prefetch" href="/site/assets/js/26.6e7f9c0d.js"><link rel="prefetch" href="/site/assets/js/27.e9d08b47.js"><link rel="prefetch" href="/site/assets/js/28.76611bff.js"><link rel="prefetch" href="/site/assets/js/29.ea593b17.js"><link rel="prefetch" href="/site/assets/js/30.c5eb0f84.js"><link rel="prefetch" href="/site/assets/js/32.5f5dd21a.js"><link rel="prefetch" href="/site/assets/js/33.0a625a25.js"><link rel="prefetch" href="/site/assets/js/34.d2733537.js"><link rel="prefetch" href="/site/assets/js/35.ddc557a5.js"><link rel="prefetch" href="/site/assets/js/36.a489edf1.js"><link rel="prefetch" href="/site/assets/js/37.136d8c88.js"><link rel="prefetch" href="/site/assets/js/38.cf5a3a6d.js"><link rel="prefetch" href="/site/assets/js/39.e9646dd4.js"><link rel="prefetch" href="/site/assets/js/40.4ce1a813.js"><link rel="prefetch" href="/site/assets/js/41.da8c6de2.js"><link rel="prefetch" href="/site/assets/js/42.c04c89ae.js"><link rel="prefetch" href="/site/assets/js/43.150fa123.js"><link rel="prefetch" href="/site/assets/js/44.fe85991f.js"><link rel="prefetch" href="/site/assets/js/45.a7ccbd7a.js"><link rel="prefetch" href="/site/assets/js/46.80bff42e.js"><link rel="prefetch" href="/site/assets/js/48.bc91a1ba.js"><link rel="prefetch" href="/site/assets/js/49.311640c6.js"><link rel="prefetch" href="/site/assets/js/50.d3346077.js"><link rel="prefetch" href="/site/assets/js/51.e7924f3c.js"><link rel="prefetch" href="/site/assets/js/52.41301aea.js"><link rel="prefetch" href="/site/assets/js/53.ef26fe4d.js"><link rel="prefetch" href="/site/assets/js/54.5f99a77e.js"><link rel="prefetch" href="/site/assets/js/55.b28f8acf.js"><link rel="prefetch" href="/site/assets/js/56.c1e1643d.js"><link rel="prefetch" href="/site/assets/js/57.bfaa829e.js"><link rel="prefetch" href="/site/assets/js/58.97c40fd9.js"><link rel="prefetch" href="/site/assets/js/59.96f5b32e.js"><link rel="prefetch" href="/site/assets/js/60.5605712f.js"><link rel="prefetch" href="/site/assets/js/61.5678ceef.js"><link rel="prefetch" href="/site/assets/js/62.6717708a.js">
    <link rel="stylesheet" href="/site/assets/css/0.styles.1ec459c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><!----> <span class="site-name">Vue SSR 指南</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/site/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/site/guide/structure.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/site/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/site/ja/guide/structure.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/site/ru/guide/structure.html" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/site/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/site/guide/structure.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/site/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/site/ja/guide/structure.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/site/ru/guide/structure.html" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div style="padding:20px 30px  0px 30px;"><a target="_blank" href="https://www.aliyun.com/minisite/goods?userCode=qya11txb" style="width:100%"><img src="https://img.alicdn.com/tfs/TB1qnR3R1L2gK0jSZFmXXc7iXXa-440-240.jpg" style="width:100%"></a></div> <ul class="sidebar-links"><li><a href="/site/zh/" class="sidebar-link">介绍</a></li><li><a href="/site/zh/guide/" class="sidebar-link">基本用法</a></li><li><a href="/site/zh/guide/universal.html" class="sidebar-link">编写通用代码</a></li><li><a href="/site/zh/guide/structure.html" class="sidebar-link">源码结构</a></li><li><a href="/site/zh/guide/routing.html" class="sidebar-link">路由和代码分割</a></li><li><a href="/site/zh/guide/data.html" class="sidebar-link">数据预取和状态</a></li><li><a href="/site/zh/guide/hydration.html" class="sidebar-link">客户端激活 (client-side hydration)</a></li><li><a href="/site/zh/guide/bundle-renderer.html" class="sidebar-link">Bundle Renderer 指引</a></li><li><a href="/site/zh/guide/build-config.html" class="sidebar-link">构建配置</a></li><li><a href="/site/zh/guide/css.html" class="sidebar-link">CSS 管理</a></li><li><a href="/site/zh/guide/head.html" class="sidebar-link">Head 管理</a></li><li><a href="/site/zh/guide/caching.html" class="sidebar-link">缓存</a></li><li><a href="/site/zh/guide/streaming.html" class="sidebar-link">流式渲染 (Streaming)</a></li><li><a href="/site/zh/guide/non-node.html" class="sidebar-link">在非 Node.js 环境中使用</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="source-code-structure"><a href="#source-code-structure" aria-hidden="true" class="header-anchor">#</a> Source Code Structure</h1> <h2 id="avoid-stateful-singletons"><a href="#avoid-stateful-singletons" aria-hidden="true" class="header-anchor">#</a> Avoid Stateful Singletons</h2> <p>When writing client-only code, we are used to the fact that our code will be evaluated in a fresh context every time. However, a Node.js server is a long-running process. When our code is required into the process, it will be evaluated once and stays in memory. This means if you create a singleton object, it will be shared between every incoming request.</p> <p>As seen in the basic example, we are <strong>creating a new root Vue instance for each request.</strong> This is similar to how each user will be using a fresh instance of the app in their own browser. If we use a shared instance across multiple requests, it will easily lead to cross-request state pollution.</p> <p>So, instead of directly creating an app instance, we should expose a factory function that can be repeatedly executed to create fresh app instances for each request:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> context<span class="token punctuation">.</span>url
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`&lt;div&gt;The visited URL is: {{ url }}&lt;/div&gt;`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And our server code now becomes:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> createApp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> req<span class="token punctuation">.</span>url <span class="token punctuation">}</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

  renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// handle error...</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>The same rule applies to router, store and event bus instances as well. Instead of exporting it directly from a module and importing it across your app, you need to create a fresh instance in <code>createApp</code> and inject it from the root Vue instance.</p> <blockquote><p>This constraint can be eliminated when using the bundle renderer with <code>{ runInNewContext: true }</code>, however it comes with some significant performance cost because a new vm context needs to be created for each request.</p></blockquote> <h2 id="introducing-a-build-step"><a href="#introducing-a-build-step" aria-hidden="true" class="header-anchor">#</a> Introducing a Build Step</h2> <p>So far, we haven't discussed how to deliver the same Vue app to the client yet. To do that, we need to use webpack to bundle our Vue app. In fact, we probably want to use webpack to bundle the Vue app on the server as well, because:</p> <ul><li><p>Typical Vue apps are built with webpack and <code>vue-loader</code>, and many webpack-specific features such as importing files via <code>file-loader</code>, importing CSS via <code>css-loader</code> would not work directly in Node.js.</p></li> <li><p>Although the latest version of Node.js fully supports ES2015 features, we still need to transpile client-side code to cater to older browsers. This again involves a build step.</p></li></ul> <p>So the basic idea is we will be using webpack to bundle our app for both client and server - the server bundle will be required by the server and used for SSR, while the client bundle is sent to the browser to hydrate the static markup.</p> <p><img src="https://cloud.githubusercontent.com/assets/499550/17607895/786a415a-5fee-11e6-9c11-45a2cfdf085c.png" alt="architecture"></p> <p>We will discuss the details of the setup in later sections - for now, let's just assume we've got the build setup figured out and we can write our Vue app code with webpack enabled.</p> <h2 id="code-structure-with-webpack"><a href="#code-structure-with-webpack" aria-hidden="true" class="header-anchor">#</a> Code Structure with webpack</h2> <p>Now that we are using webpack to process the app for both server and client, the majority of our source code can be written in a universal fashion, with access to all the webpack-powered features. At the same time, there are <a href="/site/guide/universal.html">a number of things</a> you should keep in mind when writing universal code.</p> <p>A simple project would look like this:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>src
├── components
│   ├── Foo.vue
│   ├── Bar.vue
│   └── Baz.vue
├── App.vue
├── app.js <span class="token comment"># universal entry</span>
├── entry-client.js <span class="token comment"># runs in browser only</span>
└── entry-server.js <span class="token comment"># runs on server only</span>
</code></pre></div><h3 id="app-js"><a href="#app-js" aria-hidden="true" class="header-anchor">#</a> <code>app.js</code></h3> <p><code>app.js</code> is the universal entry to our app. In a client-only app, we would create the root Vue instance right in this file and mount directly to DOM. However, for SSR that responsibility is moved into the client-only entry file. <code>app.js</code> simply exports a <code>createApp</code> function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token comment">// export a factory function for creating fresh app, router and store</span>
<span class="token comment">// instances</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// the root instance simply renders the App component.</span>
    render<span class="token punctuation">:</span> h <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="entry-client-js"><a href="#entry-client-js" aria-hidden="true" class="header-anchor">#</a> <code>entry-client.js</code>:</h3> <p>The client entry simply creates the app and mounts it to the DOM:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment">// client-specific bootstrapping logic...</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// this assumes App.vue template root element has `id=&quot;app&quot;`</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="entry-server-js"><a href="#entry-server-js" aria-hidden="true" class="header-anchor">#</a> <code>entry-server.js</code>:</h3> <p>The server entry uses a default export which is a function that can be called repeatedly for each render. At this moment, it doesn't do much other than creating and returning the app instance - but later we will perform server-side route matching and data pre-fetching logic here.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> context <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/site/assets/js/47.3938d7f5.js" defer></script><script src="/site/assets/js/app.5a972c74.js" defer></script>
  </body>
</html>
