<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Data Pre-Fetching and State | Vue SSR 指南</title>
    <meta name="description" content="Vue.js 服务端渲染指南">
    
    
    <link rel="preload" href="/site/assets/css/0.styles.1ec459c2.css" as="style"><link rel="preload" href="/site/assets/js/app.5a972c74.js" as="script"><link rel="preload" href="/site/assets/js/53.ef26fe4d.js" as="script"><link rel="prefetch" href="/site/assets/js/31.e70f56c9.js"><link rel="prefetch" href="/site/assets/js/1.4ba6ebae.js"><link rel="prefetch" href="/site/assets/js/2.535f3c53.js"><link rel="prefetch" href="/site/assets/js/3.e5730be8.js"><link rel="prefetch" href="/site/assets/js/4.0d83e6d4.js"><link rel="prefetch" href="/site/assets/js/5.9206f5fa.js"><link rel="prefetch" href="/site/assets/js/6.01fc6541.js"><link rel="prefetch" href="/site/assets/js/7.044d3af9.js"><link rel="prefetch" href="/site/assets/js/8.6a2b3380.js"><link rel="prefetch" href="/site/assets/js/9.63f778c7.js"><link rel="prefetch" href="/site/assets/js/10.f7960911.js"><link rel="prefetch" href="/site/assets/js/11.a592910a.js"><link rel="prefetch" href="/site/assets/js/12.6717a33d.js"><link rel="prefetch" href="/site/assets/js/13.682a40a0.js"><link rel="prefetch" href="/site/assets/js/14.98252396.js"><link rel="prefetch" href="/site/assets/js/15.fcc3f916.js"><link rel="prefetch" href="/site/assets/js/16.18e3e209.js"><link rel="prefetch" href="/site/assets/js/17.d5012f0a.js"><link rel="prefetch" href="/site/assets/js/18.3facfce8.js"><link rel="prefetch" href="/site/assets/js/19.6bced45f.js"><link rel="prefetch" href="/site/assets/js/20.f31829e2.js"><link rel="prefetch" href="/site/assets/js/21.9f5a2bb3.js"><link rel="prefetch" href="/site/assets/js/22.67a7b679.js"><link rel="prefetch" href="/site/assets/js/23.86b71d0a.js"><link rel="prefetch" href="/site/assets/js/24.9a66fd58.js"><link rel="prefetch" href="/site/assets/js/25.f9522ed8.js"><link rel="prefetch" href="/site/assets/js/26.6e7f9c0d.js"><link rel="prefetch" href="/site/assets/js/27.e9d08b47.js"><link rel="prefetch" href="/site/assets/js/28.76611bff.js"><link rel="prefetch" href="/site/assets/js/29.ea593b17.js"><link rel="prefetch" href="/site/assets/js/30.c5eb0f84.js"><link rel="prefetch" href="/site/assets/js/32.5f5dd21a.js"><link rel="prefetch" href="/site/assets/js/33.0a625a25.js"><link rel="prefetch" href="/site/assets/js/34.d2733537.js"><link rel="prefetch" href="/site/assets/js/35.ddc557a5.js"><link rel="prefetch" href="/site/assets/js/36.a489edf1.js"><link rel="prefetch" href="/site/assets/js/37.136d8c88.js"><link rel="prefetch" href="/site/assets/js/38.cf5a3a6d.js"><link rel="prefetch" href="/site/assets/js/39.e9646dd4.js"><link rel="prefetch" href="/site/assets/js/40.4ce1a813.js"><link rel="prefetch" href="/site/assets/js/41.da8c6de2.js"><link rel="prefetch" href="/site/assets/js/42.c04c89ae.js"><link rel="prefetch" href="/site/assets/js/43.150fa123.js"><link rel="prefetch" href="/site/assets/js/44.fe85991f.js"><link rel="prefetch" href="/site/assets/js/45.a7ccbd7a.js"><link rel="prefetch" href="/site/assets/js/46.80bff42e.js"><link rel="prefetch" href="/site/assets/js/47.3938d7f5.js"><link rel="prefetch" href="/site/assets/js/48.bc91a1ba.js"><link rel="prefetch" href="/site/assets/js/49.311640c6.js"><link rel="prefetch" href="/site/assets/js/50.d3346077.js"><link rel="prefetch" href="/site/assets/js/51.e7924f3c.js"><link rel="prefetch" href="/site/assets/js/52.41301aea.js"><link rel="prefetch" href="/site/assets/js/54.5f99a77e.js"><link rel="prefetch" href="/site/assets/js/55.b28f8acf.js"><link rel="prefetch" href="/site/assets/js/56.c1e1643d.js"><link rel="prefetch" href="/site/assets/js/57.bfaa829e.js"><link rel="prefetch" href="/site/assets/js/58.97c40fd9.js"><link rel="prefetch" href="/site/assets/js/59.96f5b32e.js"><link rel="prefetch" href="/site/assets/js/60.5605712f.js"><link rel="prefetch" href="/site/assets/js/61.5678ceef.js"><link rel="prefetch" href="/site/assets/js/62.6717708a.js">
    <link rel="stylesheet" href="/site/assets/css/0.styles.1ec459c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/site/" class="home-link router-link-active"><!----> <span class="site-name">Vue SSR 指南</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/site/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/site/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/site/guide/data.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/site/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/site/ja/guide/data.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/site/ru/guide/data.html" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/site/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/site/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/site/guide/data.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/site/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/site/ja/guide/data.html" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/site/ru/guide/data.html" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div style="padding:20px 30px  0px 30px;"><a target="_blank" href="https://www.aliyun.com/minisite/goods?userCode=qya11txb" style="width:100%"><img src="https://img.alicdn.com/tfs/TB1qnR3R1L2gK0jSZFmXXc7iXXa-440-240.jpg" style="width:100%"></a></div> <ul class="sidebar-links"><li><a href="/site/zh/" class="sidebar-link">介绍</a></li><li><a href="/site/zh/guide/" class="sidebar-link">基本用法</a></li><li><a href="/site/zh/guide/universal.html" class="sidebar-link">编写通用代码</a></li><li><a href="/site/zh/guide/structure.html" class="sidebar-link">源码结构</a></li><li><a href="/site/zh/guide/routing.html" class="sidebar-link">路由和代码分割</a></li><li><a href="/site/zh/guide/data.html" class="sidebar-link">数据预取和状态</a></li><li><a href="/site/zh/guide/hydration.html" class="sidebar-link">客户端激活 (client-side hydration)</a></li><li><a href="/site/zh/guide/bundle-renderer.html" class="sidebar-link">Bundle Renderer 指引</a></li><li><a href="/site/zh/guide/build-config.html" class="sidebar-link">构建配置</a></li><li><a href="/site/zh/guide/css.html" class="sidebar-link">CSS 管理</a></li><li><a href="/site/zh/guide/head.html" class="sidebar-link">Head 管理</a></li><li><a href="/site/zh/guide/caching.html" class="sidebar-link">缓存</a></li><li><a href="/site/zh/guide/streaming.html" class="sidebar-link">流式渲染 (Streaming)</a></li><li><a href="/site/zh/guide/non-node.html" class="sidebar-link">在非 Node.js 环境中使用</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="data-pre-fetching-and-state"><a href="#data-pre-fetching-and-state" aria-hidden="true" class="header-anchor">#</a> Data Pre-Fetching and State</h1> <h2 id="data-store"><a href="#data-store" aria-hidden="true" class="header-anchor">#</a> Data Store</h2> <p>During SSR, we are essentially rendering a &quot;snapshot&quot; of our app. The asynchronous data from our components needs to be available before we mount the client side app - otherwise the client app would render using different state and the hydration would fail.</p> <p>To address this, the fetched data needs to live outside the view components, in a dedicated data store, or a &quot;state container&quot;. On the server, we can pre-fetch and fill data into the store while rendering. In addition, we will serialize and inline the state in the HTML after the app has finished rendering. The client-side store can directly pick up the inlined state before we mount the app.</p> <p>We will be using the official state management library <a href="https://github.com/vuejs/vuex/" target="_blank" rel="noopener noreferrer">Vuex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for this purpose. Let's create a <code>store.js</code> file, with some mocked logic for fetching an item based on an id:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>

<span class="token comment">// Assume we have a universal API that returns Promises</span>
<span class="token comment">// and ignore the implementation details</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./api'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStore</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// IMPORTANT: state must be a function so the module can be</span>
    <span class="token comment">// instantiated multiple times</span>
    state<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      items<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">fetchItem</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// return the Promise via `store.dispatch()` so that we know</span>
        <span class="token comment">// when the data has been fetched</span>
        <span class="token keyword">return</span> <span class="token function">fetchItem</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setItem'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">setItem</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Vue<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>items<span class="token punctuation">,</span> id<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>Most of the time, you should wrap <code>state</code> in a function, so that it will not leak into the next server-side runs.
<a href="/site/guide/structure.html#avoid-stateful-singletons">More info</a></p></div> <p>And update <code>app.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex-router-sync'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// create router and store instances</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// sync so that route state is available as part of the store</span>
  <span class="token function">sync</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> router<span class="token punctuation">)</span>

  <span class="token comment">// create the app instance, injecting both the router and the store</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    router<span class="token punctuation">,</span>
    store<span class="token punctuation">,</span>
    render<span class="token punctuation">:</span> h <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// expose the app, the router and the store.</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="logic-collocation-with-components"><a href="#logic-collocation-with-components" aria-hidden="true" class="header-anchor">#</a> Logic Collocation with Components</h2> <p>So, where do we place the code that dispatches the data-fetching actions?</p> <p>The data we need to fetch is determined by the route visited - which also determines what components are rendered. In fact, the data needed for a given route is also the data needed by the components rendered at that route. So it would be natural to place the data fetching logic inside route components.</p> <p>We will use the <code>serverPrefetch</code> option (new in 2.6.0+) in our components. This option is recognized by the server renderer and will pause the rendering until the promise it returns is resolved. This allows us to &quot;wait&quot; on async data during the rendering process.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>You can use <code>serverPrefetch</code> in any component, not just the route-level components.</p></div> <p>Here is an example <code>Item.vue</code> component that is rendered at the <code>'/item/:id'</code> route. Since the component instance is already created at this point, it has access to <code>this</code>:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- Item.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ item.title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-else</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// display the item from store state.</span>
    <span class="token function">item</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>items<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// Server-side only</span>
  <span class="token comment">// This will be called by the server renderer automatically</span>
  <span class="token function">serverPrefetch</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// return the Promise from the action</span>
    <span class="token comment">// so that the component waits before rendering</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// Client-side only</span>
  <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If we didn't already do it on the server</span>
    <span class="token comment">// we fetch the item (will first show the loading text)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">fetchItem</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// return the Promise from the action</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'fetchItem'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>You should check if the component was server-side rendered in the <code>mounted</code> hook to avoid executing the logic twice.</p></div> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>You may find the same <code>fetchItem()</code> logic repeated multiple times (in <code>serverPrefetch</code>, <code>mounted</code> and <code>watch</code> callbacks) in each component - it is recommended to create your own abstraction (e.g. a mixin or a plugin) to simplify such code.</p></div> <h2 id="final-state-injection"><a href="#final-state-injection" aria-hidden="true" class="header-anchor">#</a> Final State Injection</h2> <p>Now we know that the rendering process will wait for data fetching in our components, how do we know when it is &quot;done&quot;? In order to do that, we need to attach a <code>rendered</code> callback to the render context (also new in 2.6), which the server renderer will call when the entire rendering process is finished. At this moment, the store should have been filled with the final state. We can then inject it on to the context in that callback:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// entry-server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> context <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// This `rendered` hook is called when the app has finished rendering</span>
      context<span class="token punctuation">.</span><span class="token function-variable function">rendered</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// After the app is rendered, our store is now</span>
        <span class="token comment">// filled with the state from our components.</span>
        <span class="token comment">// When we attach the state to the context, and the `template` option</span>
        <span class="token comment">// is used for the renderer, the state will automatically be</span>
        <span class="token comment">// serialized and injected into the HTML as `window.__INITIAL_STATE__`.</span>
        context<span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span>state
      <span class="token punctuation">}</span>

      <span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When using <code>template</code>, <code>context.state</code> will automatically be embedded in the final HTML as <code>window.__INITIAL_STATE__</code> state. On the client, the store should pick up the state before mounting the application:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// entry-client.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> store <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// We initialize the store state with the data injected from the server</span>
  store<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="store-code-splitting"><a href="#store-code-splitting" aria-hidden="true" class="header-anchor">#</a> Store Code Splitting</h2> <p>In a large application, our Vuex store will likely be split into multiple modules. Of course, it is also possible to code-split these modules into corresponding route component chunks. Suppose we have the following store module:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store/modules/foo.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  namespaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

  <span class="token comment">// IMPORTANT: state must be a function so the module can be</span>
  <span class="token comment">// instantiated multiple times</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    inc<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'inc'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    inc<span class="token punctuation">:</span> state <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>count<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We can use <code>store.registerModule</code> to lazy-register this module in a route component's <code>serverPrefetch</code> hook:</p> <div class="language-html extra-class"><pre class="language-html"><code>// inside a route component
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{{ fooCount }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
<span class="token comment">// import the module here instead of in `store/index.js`</span>
<span class="token keyword">import</span> fooStoreModule <span class="token keyword">from</span> <span class="token string">'../store/modules/foo'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">fooCount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>count
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// Server-side only</span>
  <span class="token function">serverPrefetch</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> fooStoreModule<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fooInc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// Client-side only</span>
  <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We already incremented 'count' on the server</span>
    <span class="token comment">// We know by checking if the 'foo' state already exists</span>
    <span class="token keyword">const</span> alreadyIncremented <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>foo

    <span class="token comment">// We register the foo module</span>
    <span class="token comment">// Preserve the previous state if it was injected from the server</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> fooStoreModule<span class="token punctuation">,</span> <span class="token punctuation">{</span> preserveState<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyIncremented<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fooInc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// IMPORTANT: avoid duplicate module registration on the client</span>
  <span class="token comment">// when the route is visited multiple times.</span>
  <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">unregisterModule</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">fooInc</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'foo/inc'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Because the module is now a dependency of the route component, it will be moved into the route component's async chunk by webpack.</p> <div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>Don't forget to use the <code>preserveState: true</code> option for <code>registerModule</code> so we keep the state injected by the server.</p></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/site/assets/js/53.ef26fe4d.js" defer></script><script src="/site/assets/js/app.5a972c74.js" defer></script>
  </body>
</html>
