<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>构建配置 | Vue SSR 中文指南</title>
    <meta name="description" content="Vue.js 服务端渲染指南，Vue SSR 中文文档，Vue SSR 国内镜像，Vue SSR 中文网，Vue SSR 官网打开慢，Vue SSR 官网打不开">
    
    
    <link rel="preload" href="/assets/css/0.styles.0d503026.css" as="style"><link rel="preload" href="/assets/js/app.da11bd17.js" as="script"><link rel="preload" href="/assets/js/12.6717a33d.js" as="script"><link rel="prefetch" href="/assets/js/31.e70f56c9.js"><link rel="prefetch" href="/assets/js/1.4ba6ebae.js"><link rel="prefetch" href="/assets/js/2.535f3c53.js"><link rel="prefetch" href="/assets/js/3.e5730be8.js"><link rel="prefetch" href="/assets/js/4.0d83e6d4.js"><link rel="prefetch" href="/assets/js/5.9206f5fa.js"><link rel="prefetch" href="/assets/js/6.01fc6541.js"><link rel="prefetch" href="/assets/js/7.044d3af9.js"><link rel="prefetch" href="/assets/js/8.6a2b3380.js"><link rel="prefetch" href="/assets/js/9.63f778c7.js"><link rel="prefetch" href="/assets/js/10.f7960911.js"><link rel="prefetch" href="/assets/js/11.a592910a.js"><link rel="prefetch" href="/assets/js/13.682a40a0.js"><link rel="prefetch" href="/assets/js/14.98252396.js"><link rel="prefetch" href="/assets/js/15.fcc3f916.js"><link rel="prefetch" href="/assets/js/16.18e3e209.js"><link rel="prefetch" href="/assets/js/17.d5012f0a.js"><link rel="prefetch" href="/assets/js/18.3facfce8.js"><link rel="prefetch" href="/assets/js/19.6bced45f.js"><link rel="prefetch" href="/assets/js/20.f31829e2.js"><link rel="prefetch" href="/assets/js/21.9f5a2bb3.js"><link rel="prefetch" href="/assets/js/22.67a7b679.js"><link rel="prefetch" href="/assets/js/23.86b71d0a.js"><link rel="prefetch" href="/assets/js/24.9a66fd58.js"><link rel="prefetch" href="/assets/js/25.f9522ed8.js"><link rel="prefetch" href="/assets/js/26.6e7f9c0d.js"><link rel="prefetch" href="/assets/js/27.e9d08b47.js"><link rel="prefetch" href="/assets/js/28.76611bff.js"><link rel="prefetch" href="/assets/js/29.ea593b17.js"><link rel="prefetch" href="/assets/js/30.c5eb0f84.js"><link rel="prefetch" href="/assets/js/32.5f5dd21a.js"><link rel="prefetch" href="/assets/js/33.0a625a25.js"><link rel="prefetch" href="/assets/js/34.d2733537.js"><link rel="prefetch" href="/assets/js/35.ddc557a5.js"><link rel="prefetch" href="/assets/js/36.a489edf1.js"><link rel="prefetch" href="/assets/js/37.136d8c88.js"><link rel="prefetch" href="/assets/js/38.cf5a3a6d.js"><link rel="prefetch" href="/assets/js/39.e9646dd4.js"><link rel="prefetch" href="/assets/js/40.4ce1a813.js"><link rel="prefetch" href="/assets/js/41.da8c6de2.js"><link rel="prefetch" href="/assets/js/42.c04c89ae.js"><link rel="prefetch" href="/assets/js/43.150fa123.js"><link rel="prefetch" href="/assets/js/44.fe85991f.js"><link rel="prefetch" href="/assets/js/45.a7ccbd7a.js"><link rel="prefetch" href="/assets/js/46.80bff42e.js"><link rel="prefetch" href="/assets/js/47.3938d7f5.js"><link rel="prefetch" href="/assets/js/48.bc91a1ba.js"><link rel="prefetch" href="/assets/js/49.311640c6.js"><link rel="prefetch" href="/assets/js/50.d3346077.js"><link rel="prefetch" href="/assets/js/51.e7924f3c.js"><link rel="prefetch" href="/assets/js/52.41301aea.js"><link rel="prefetch" href="/assets/js/53.ef26fe4d.js"><link rel="prefetch" href="/assets/js/54.5f99a77e.js"><link rel="prefetch" href="/assets/js/55.b28f8acf.js"><link rel="prefetch" href="/assets/js/56.c1e1643d.js"><link rel="prefetch" href="/assets/js/57.bfaa829e.js"><link rel="prefetch" href="/assets/js/58.97c40fd9.js"><link rel="prefetch" href="/assets/js/59.96f5b32e.js"><link rel="prefetch" href="/assets/js/60.5605712f.js"><link rel="prefetch" href="/assets/js/61.5678ceef.js"><link rel="prefetch" href="/assets/js/62.6717708a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0d503026.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vue SSR 中文指南</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/build-config.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/ru/" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="/zh/api/" class="nav-link">API 参考</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/guide/build-config.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/ru/" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-ssr-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div style="padding:20px 30px  0px 30px;"><a target="_blank" href="https://www.aliyun.com/minisite/goods?userCode=qya11txb" style="width:100%"><img src="https://img.alicdn.com/tfs/TB1qnR3R1L2gK0jSZFmXXc7iXXa-440-240.jpg" style="width:100%"></a></div> <ul class="sidebar-links"><li><a href="/zh/" class="sidebar-link">介绍</a></li><li><a href="/zh/guide/" class="sidebar-link">基本用法</a></li><li><a href="/zh/guide/universal.html" class="sidebar-link">编写通用代码</a></li><li><a href="/zh/guide/structure.html" class="sidebar-link">源码结构</a></li><li><a href="/zh/guide/routing.html" class="sidebar-link">路由和代码分割</a></li><li><a href="/zh/guide/data.html" class="sidebar-link">数据预取和状态</a></li><li><a href="/zh/guide/hydration.html" class="sidebar-link">客户端激活 (client-side hydration)</a></li><li><a href="/zh/guide/bundle-renderer.html" class="sidebar-link">Bundle Renderer 指引</a></li><li><a href="/zh/guide/build-config.html" class="active sidebar-link">构建配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guide/build-config.html#服务器配置-server-config" class="sidebar-link">服务器配置 (Server Config)</a></li><li class="sidebar-sub-header"><a href="/zh/guide/build-config.html#客户端配置-client-config" class="sidebar-link">客户端配置 (Client Config)</a></li></ul></li><li><a href="/zh/guide/css.html" class="sidebar-link">CSS 管理</a></li><li><a href="/zh/guide/head.html" class="sidebar-link">Head 管理</a></li><li><a href="/zh/guide/caching.html" class="sidebar-link">缓存</a></li><li><a href="/zh/guide/streaming.html" class="sidebar-link">流式渲染 (Streaming)</a></li><li><a href="/zh/guide/non-node.html" class="sidebar-link">在非 Node.js 环境中使用</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="构建配置"><a href="#构建配置" aria-hidden="true" class="header-anchor">#</a> 构建配置</h1> <p>我们假设你已经知道，如何为纯客户端 (client-only) 项目配置 webpack。服务器端渲染 (SSR) 项目的配置大体上与纯客户端项目类似，但是我们建议将配置分为三个文件：<em>base</em>, <em>client</em> 和 <em>server</em>。基本配置 (base config) 包含在两个环境共享的配置，例如，输出路径 (output path)，别名 (alias) 和 loader。服务器配置 (server config) 和客户端配置 (client config)，可以通过使用 <a href="https://github.com/survivejs/webpack-merge" target="_blank" rel="noopener noreferrer">webpack-merge<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来简单地扩展基本配置。</p> <h2 id="服务器配置-server-config"><a href="#服务器配置-server-config" aria-hidden="true" class="header-anchor">#</a> 服务器配置 (Server Config)</h2> <p>服务器配置，是用于生成传递给 <code>createBundleRenderer</code> 的 server bundle。它应该是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-node-externals'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> VueSSRServerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/server-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将 entry 指向应用程序的 server entry 文件</span>
  entry<span class="token punctuation">:</span> <span class="token string">'/path/to/entry-server.js'</span><span class="token punctuation">,</span>

  <span class="token comment">// 这允许 webpack 以 Node 适用方式(Node-appropriate fashion)处理动态导入(dynamic import)，</span>
  <span class="token comment">// 并且还会在编译 Vue 组件时，</span>
  <span class="token comment">// 告知 `vue-loader` 输送面向服务器代码(server-oriented code)。</span>
  target<span class="token punctuation">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>

  <span class="token comment">// 对 bundle renderer 提供 source map 支持</span>
  devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span>

  <span class="token comment">// 此处告知 server bundle 使用 Node 风格导出模块(Node-style exports)</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    libraryTarget<span class="token punctuation">:</span> <span class="token string">'commonjs2'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// https://webpack.js.org/configuration/externals/#function</span>
  <span class="token comment">// https://github.com/liady/webpack-node-externals</span>
  <span class="token comment">// 外置化应用程序依赖模块。可以使服务器构建速度更快，</span>
  <span class="token comment">// 并生成较小的 bundle 文件。</span>
  externals<span class="token punctuation">:</span> <span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 不要外置化 webpack 需要处理的依赖模块。</span>
    <span class="token comment">// 你可以在这里添加更多的文件类型。例如，未处理 *.vue 原始文件，</span>
    <span class="token comment">// 你还应该将修改 `global`（例如 polyfill）的依赖模块列入白名单</span>
    whitelist<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// 这是将服务器的整个输出</span>
  <span class="token comment">// 构建为单个 JSON 文件的插件。</span>
  <span class="token comment">// 默认文件名为 `vue-ssr-server-bundle.json`</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">VueSSRServerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在生成 <code>vue-ssr-server-bundle.json</code> 之后，只需将文件路径传递给 <code>createBundleRenderer</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span><span class="token string">'/path/to/vue-ssr-server-bundle.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ……renderer 的其他选项</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>又或者，你还可以将 bundle 作为对象传递给 <code>createBundleRenderer</code>。这对开发过程中的热重载是很有用的 - 具体请查看 HackerNews demo 的<a href="https://github.com/vuejs/vue-hackernews-2.0/blob/master/build/setup-dev-server.js" target="_blank" rel="noopener noreferrer">参考设置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="扩展说明-externals-caveats"><a href="#扩展说明-externals-caveats" aria-hidden="true" class="header-anchor">#</a> 扩展说明 (Externals Caveats)</h3> <p>请注意，在 <code>externals</code> 选项中，我们将 CSS 文件列入白名单。这是因为从依赖模块导入的 CSS 还应该由 webpack 处理。如果你导入依赖于 webpack 的任何其他类型的文件（例如 <code>*.vue</code>, <code>*.sass</code>），那么你也应该将它们添加到白名单中。</p> <p>如果你使用 <code>runInNewContext: 'once'</code> 或 <code>runInNewContext: true</code>，那么你还应该将修改 <code>global</code> 的 polyfill 列入白名单，例如 <code>babel-polyfill</code>。这是因为当使用新的上下文模式时，**server bundle 中的代码具有自己的 <code>global</code> 对象。**由于在使用 Node 7.6+ 时，在服务器并不真正需要它，所以实际上只需在客户端 entry 导入它。</p> <h2 id="客户端配置-client-config"><a href="#客户端配置-client-config" aria-hidden="true" class="header-anchor">#</a> 客户端配置 (Client Config)</h2> <p>客户端配置 (client config) 和基本配置 (base config) 大体上相同。显然你需要把 <code>entry</code> 指向你的客户端入口文件。除此之外，如果你使用 <code>CommonsChunkPlugin</code>，请确保仅在客户端配置 (client config) 中使用，因为服务器包需要单独的入口 chunk。</p> <h3 id="生成-clientmanifest"><a href="#生成-clientmanifest" aria-hidden="true" class="header-anchor">#</a> 生成 <code>clientManifest</code></h3> <blockquote><p>需要版本 2.3.0+</p></blockquote> <p>除了 server bundle 之外，我们还可以生成客户端构建清单 (client build manifest)。使用客户端清单 (client manifest) 和服务器 bundle(server bundle)，renderer 现在具有了<em>服务器和客户端</em>的构建信息，因此它可以自动推断和注入<a href="https://css-tricks.com/prefetching-preloading-prebrowsing/" target="_blank" rel="noopener noreferrer">资源预加载 / 数据预取指令(preload / prefetch directive)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，以及 css 链接 / script 标签到所渲染的 HTML。</p> <p>好处是双重的：</p> <ol><li><p>在生成的文件名中有哈希时，可以取代 <code>html-webpack-plugin</code> 来注入正确的资源 URL。</p></li> <li><p>在通过 webpack 的按需代码分割特性渲染 bundle 时，我们可以确保对 chunk 进行最优化的资源预加载/数据预取，并且还可以将所需的异步 chunk 智能地注入为 <code>&lt;script&gt;</code> 标签，以避免客户端的瀑布式请求 (waterfall request)，以及改善可交互时间 (TTI - time-to-interactive)。</p></li></ol> <p>要使用客户端清单 (client manifest)，客户端配置 (client config) 将如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> VueSSRClientPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/client-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token string">'/path/to/entry-client.js'</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 重要信息：这将 webpack 运行时分离到一个引导 chunk 中，</span>
    <span class="token comment">// 以便可以在之后正确注入异步 chunk。</span>
    <span class="token comment">// 这也为你的 应用程序/vendor 代码提供了更好的缓存。</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;manifest&quot;</span><span class="token punctuation">,</span>
      minChunks<span class="token punctuation">:</span> <span class="token number">Infinity</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 此插件在输出目录中</span>
    <span class="token comment">// 生成 `vue-ssr-client-manifest.json`。</span>
    <span class="token keyword">new</span> <span class="token class-name">VueSSRClientPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后，你就可以使用生成的客户端清单 (client manifest) 以及页面模板：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/template.html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'/path/to/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'/path/to/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  template<span class="token punctuation">,</span>
  clientManifest
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过以上设置，使用代码分割特性构建后的服务器渲染的 HTML 代码，将看起来如下（所有都是自动注入）：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 用于当前渲染的 chunk 会被资源预加载(preload) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/manifest.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/0.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 未用到的异步 chunk 会被数据预取(prefetch)（次要优先级） --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>prefetch<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/1.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 应用程序内容 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-server-rendered</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>async<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- manifest chunk 优先 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/manifest.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 在主 chunk 之前注入异步 chunk --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/0.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="手动资源注入-manual-asset-injection"><a href="#手动资源注入-manual-asset-injection" aria-hidden="true" class="header-anchor">#</a> 手动资源注入(Manual Asset Injection)</h3> <p>默认情况下，当提供 <code>template</code> 渲染选项时，资源注入是自动执行的。但是有时候，你可能需要对资源注入的模板进行更细粒度 (finer-grained) 的控制，或者你根本不使用模板。在这种情况下，你可以在创建 renderer 并手动执行资源注入时，传入 <code>inject: false</code>。</p> <p>在 <code>renderToString</code> 回调函数中，你传入的 <code>context</code> 对象会暴露以下方法：</p> <ul><li><p><code>context.renderStyles()</code></p> <p>这将返回内联 <code>&lt;style&gt;</code> 标签包含所有关键 CSS(critical CSS) ，其中关键 CSS 是在要用到的 <code>*.vue</code> 组件的渲染过程中收集的。有关更多详细信息，请查看 <a href="/zh/guide/css.html">CSS 管理</a>。</p> <p>如果提供了 <code>clientManifest</code>，返回的字符串中，也将包含着 <code>&lt;link rel=&quot;stylesheet&quot;&gt;</code> 标签内由 webpack 输出(webpack-emitted)的 CSS 文件（例如，使用 <code>extract-text-webpack-plugin</code> 提取的 CSS，或使用 <code>file-loader</code> 导入的 CSS）</p></li> <li><p><code>context.renderState(options?: Object)</code></p> <p>此方法序列化 <code>context.state</code> 并返回一个内联的 script，其中状态被嵌入在 <code>window.__INITIAL_STATE__</code> 中。</p> <p>上下文状态键 (context state key) 和 window 状态键 (window state key)，都可以通过传递选项对象进行自定义：</p> <div class="language-js extra-class"><pre class="language-js"><code>context<span class="token punctuation">.</span><span class="token function">renderState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  contextKey<span class="token punctuation">:</span> <span class="token string">'myCustomState'</span><span class="token punctuation">,</span>
  windowKey<span class="token punctuation">:</span> <span class="token string">'__MY_STATE__'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// -&gt; &lt;script&gt;window.__MY_STATE__={...}&lt;/script&gt;</span>
</code></pre></div></li> <li><p><code>context.renderScripts()</code></p> <ul><li>需要 <code>clientManifest</code></li></ul> <p>此方法返回引导客户端应用程序所需的 <code>&lt;script&gt;</code> 标签。当在应用程序代码中使用异步代码分割 (async code-splitting) 时，此方法将智能地正确的推断需要引入的那些异步 chunk。</p></li> <li><p><code>context.renderResourceHints()</code></p> <ul><li>需要 <code>clientManifest</code></li></ul> <p>此方法返回当前要渲染的页面，所需的 <code>&lt;link rel=&quot;preload/prefetch&quot;&gt;</code> 资源提示 (resource hint)。默认情况下会：</p> <ul><li>预加载页面所需的 JavaScript 和 CSS 文件</li> <li>预取异步 JavaScript chunk，之后可能会用于渲染</li></ul> <p>使用 <a href="/zh/api/#shouldpreload"><code>shouldPreload</code></a> 选项可以进一步自定义要预加载的文件。</p></li> <li><p><code>context.getPreloadFiles()</code></p> <ul><li>需要 <code>clientManifest</code></li></ul> <p>此方法不返回字符串 - 相反，它返回一个数组，此数组是由要预加载的资源文件对象所组成。这可以用在以编程方式 (programmatically) 执行 HTTP/2 服务器推送 (HTTP/2 server push)。</p></li></ul> <p>由于传递给 <code>createBundleRenderer</code> 的 <code>template</code> 将会使用 <code>context</code> 对象进行插值，你可以（通过传入 <code>inject: false</code>）在模板中使用这些方法：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 使用三花括号(triple-mustache)进行 HTML 不转义插值(non-HTML-escaped interpolation) --&gt;</span>
    {{{ renderResourceHints() }}}
    {{{ renderStyles() }}}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
    {{{ renderState() }}}
    {{{ renderScripts() }}}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果你根本没有使用 <code>template</code>，你可以自己拼接字符串。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/zh/guide/bundle-renderer.html" class="prev">
          Bundle Renderer 指引
        </a></span> <span class="next"><a href="/zh/guide/css.html">
          CSS 管理
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/12.6717a33d.js" defer></script><script src="/assets/js/app.da11bd17.js" defer></script>
  </body>
</html>
